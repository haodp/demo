package com.demo.common.filter;import java.io.IOException;import java.util.ArrayList;import java.util.Arrays;import java.util.List;import javax.servlet.Filter;import javax.servlet.FilterChain;import javax.servlet.FilterConfig;import javax.servlet.ServletException;import javax.servlet.ServletRequest;import javax.servlet.ServletResponse;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;import org.apache.commons.lang3.StringUtils;import com.demo.common.bean.Result;import com.demo.common.util.IpUtil;import com.demo.common.util.JsonMapper;import com.demo.common.util.PropertiesUtil;import com.demo.common.util.StringUtil;import lombok.extern.slf4j.Slf4j;/** * Created on 16/2/6. */@Slf4jpublic class IpControlFilter implements Filter {    private static List<String> voidIpList = new ArrayList<String>();    public void init(FilterConfig config) throws ServletException {    	String ip = PropertiesUtil.get("IP_ADDRESS");    	if(StringUtil.isEmpty(ip)){    		return;    	}    	String[] strings = ip.split(",");    	voidIpList.addAll(Arrays.asList(strings));    }    /**     * 攻击网站URL的屏蔽掉。     *     */    public void doFilter(ServletRequest req, ServletResponse resp, FilterChain chain) throws IOException, ServletException {        HttpServletRequest request = (HttpServletRequest) req;        HttpServletResponse response = (HttpServletResponse) resp;        String ip = IpUtil.getUserIP(request);        if (voidIpList.contains(ip)) {            noAuth(request, response);            return;        }        chain.doFilter(req, resp);        return;    }    /**     * 无权处理     */    public void noAuth(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {        String servletPath = request.getServletPath();        request.setAttribute("currentUrl", servletPath);        String requestAccept = request.getHeader("accept");        String contentType = "text/html";        //判断请求类型        if (StringUtils.isNotEmpty(requestAccept)) {            if (StringUtils.contains(requestAccept, "application/json") || StringUtils.contains(requestAccept, "text/javascript") || StringUtils                    .contains(requestAccept, "text/json")) {                contentType = "application/json";            }        }        response.setHeader("Content-Type", contentType + "; charset=UTF-8");        if (contentType.equals("text/html")) {            clientRedirect(response, "/index.jsp");        } else if (contentType.equals("application/json")) {            Result result = Result.fail("没有访问权限，如需要访问，请联系管理员！");            response.getWriter().print(JsonMapper.obj2String(result));        } else {            clientRedirect(response, "/index.jsp");        }    }    /**     * 客户端的重定向，将页面重定向为 path?ret=encodeURIComponent(window.location.href)     */    public static void clientRedirect(HttpServletResponse response, String path) throws IOException {        response.setHeader("Content-Type", "text/html");        response.getWriter().println("<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Strict//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\">\n"                + "<html xmlns=\"http://www.w3.org/1999/xhtml\">\n" + "<head>\n" + "<meta http-equiv=\"content-type\" content=\"text/html; charset=UTF-8\"/>\n"                + "<title>跳转中...</title>\n" + "</head>\n" + "<body>\n" + "跳转中，请稍候...\n" + "<script type=\"text/javascript\">//<![CDATA[\n"                + "window.location.href='" + path + "?ret='+encodeURIComponent(window.location.href);\n" + "//]]></script>\n" + "</body>\n" + "</html>\n");    }    public void destroy() {    }}